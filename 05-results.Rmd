# Results

Part 1 EDA  

Individual Variable Analysis for NYC crime data.  

##Plot1:RACE
```{r}
Race_Count<-dt%>%
  group_by(race) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count)) %>% 
  ggplot(aes(fct_reorder(race,count,.desc = FALSE),count))+
  geom_col(color="grey50",fill="lightpink")+
  coord_flip()+
  xlab("Which RACE")+
  ylab("Count of each RACE")+
  geom_text(aes(label=count), hjust=0.5)
Race_Count
```
As we can see in the plot, most criminals are Black. The amount of black prepetrators is greater than white hispanic, white and black hispanic prepetrtors combined.

##Plot2:SEX
```{r}
Sex_Count<-dt%>%
  group_by(sex) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count)) %>% 
  ggplot(aes(fct_reorder(sex,count,.desc = FALSE),count))+
  geom_col(color="grey50",fill="lightyellow")+
  coord_flip()+
  xlab("Which Sex")+
  ylab("Count of each Sex")+
  geom_text(aes(label=count), hjust=1.2)
Sex_Count
```
Much more perpetrators are male.Male perpetrator population is five times as large as female perpetrators population.

##Plot3:AGE GROUP
```{r}
Age_Count<-dt%>%
  group_by(age) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count)) %>% 
  ggplot(aes(fct_reorder(age,count,.desc = FALSE),count))+
  geom_col(color="grey50",fill="lightgreen")+
  coord_flip()+
  xlab("Which AGE GROUP")+
  ylab("Count of each AGE GROUP")+
  geom_text(aes(label=count))
Age_Count
```
Most perpetrators aged between 25-44.

##Plot4:BORO
```{r}
Boro_Count<-dt%>%
  group_by(boro) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count)) %>% 
  ggplot(aes(fct_reorder(boro,count,.desc = FALSE),count))+
  geom_col(color="grey50",fill="lightblue")+
  coord_flip()+
  xlab("Which Boro")+
  ylab("Count of each Boro")+
  geom_text(aes(label=count), hjust=1.2)
Boro_Count
```
Brooklyn is the most dangerous borough with most crime cases in 2020.

##Plot5:Offense Type (Top 10)
```{r}
Offense_Count<-dt%>%
  group_by(offense) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count)) %>% 
  top_n(10)%>%
  ggplot(aes(fct_reorder(offense,count,.desc = F),count))+
  geom_col(color="grey30",fill="#E69F00")+
  coord_flip()+
  xlab("Number of Cases")+
  ylab("Type of Crimes")+
  ggtitle("Number of Cases of Each Crime Type")+
  geom_text(aes(label=count),hjust=1.2)
Offense_Count
```

Multi-variable analysis (Mosaic Plot/Density Plot)  

##PLOT 1: age+sex (Mosaic Plot)
```{r}
beauty_color<-c("#999999","#E69F00","#D55E00", "#0072B2","#CC79A7")
dt%>%
  group_by(age,sex) %>%
  dplyr::summarise(count = n())
vcd::mosaic(age~sex,dt,highlighting_fill=beauty_color,labeling_args=list(rot_labels=c(40,40,40,0,0)))
```
##PLOT 2: sex+age+boro (facet histogram/interactive version in chapter 06)
```{r}
ggplot(data=dt) +
   geom_bar(aes(x=sex,fill=factor(age)))+
   labs(title = "The race distribution among different sex groups",fill="offense")+
   facet_wrap(~boro)
```
##PLOT 3: boro+race (Density Plot)
```{r}
ggplot(data=dt, aes(x=boro, group=race, fill=race)) +
  geom_density(adjust=1.5, alpha=.4) +
  theme_ipsum()
```
##PLOT 4: boro+race(Tree Map)
```{r}
dt_tree<-dt%>%
  select(boro,race)%>%
  group_by(race,boro)%>%
  dplyr::summarise(n=n())
g1<-dt_tree$race
g2<-dt_tree$boro
value<-dt_tree$n
dt_ff<-data.frame(g1,g2,value)
  
treemap(dt_ff,index=c("g1","g2"),vSize="value",type="index",palette = "Set3",title="Treemap:group=Race/subgroup=Boro",fontsize.title=12)

```
Following from the EDA above, we can clearly see crime case number differs in different borough/sex/race/age: Brooklyn and Manhattan had the most crimes. Black is the racial group with highest crime cases yet in Staten island,high risk group is white, and in Queens, the high risk group is Asian. No matter in which borogh, the highest risk age group is always 25-44. 
As for predictive policing, people will tag certain racial group/borough/age group/sex as High risk based on the statistics result shown above. But is this reasonable? We will further discuss the bias in predictive policing later. Now let's take a deeper look at the crimes by precinct by using spatial analysis tool.  

Spacial Analysis  

#Overall Features
```{r}
sp1<- st_as_sf(dt, coords = c('Longitude', 'Latitude'), crs = 4326) #Create spatial data object
plot(sp1) 
```

#Crime Rate by precinct
```{r}
#Create the data set Order by precinct
crime_data<-dt%>%
  group_by(precinct) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count))

colnames(crime_data)<-c("dtprecinct","2020") #Renmae colnames
head(crime_data)

#Use OGR to read in the shp file
ny_precinct <- readOGR(dsn = "/Users/jessie/Downloads/Police Precincts/geo_export_9f1de9c6-45df-4c9a-8939-1843acf3378c.shp") 
head(ny_precinct@data,6)
```
#Combine the data set
```{r}
ny_precinct@data <- left_join(ny_precinct@data, crime_data, by = c('precinct' = 'dtprecinct'))
head(ny_precinct@data)
ny_precinct_f <- fortify(ny_precinct)
ny_precinct$id <- row.names(ny_precinct)
ny_precinct_f <- left_join(ny_precinct_f, ny_precinct@data) 
```

#Plot the crime cases in the map
#plots the precinct with their respective crime case number
```{r}
ggplot(ny_precinct_f, aes(long, lat, group = group, fill=`2020`)) +
  geom_polygon() + geom_path(colour="white", lwd=0.05) + coord_equal() +
  labs(x = "lat", y = "lon",
       fill = "Crime rate") +
  scale_fill_gradient2(low = "#BDBDBD",high = "#2196F3", # colors
                        name = "Crime Case Number") + # legend options
  ggtitle("Crime rate (2020) ") 
```
#plots the precinct with crime cases above 3000 Mark as RED
```{r}
ggplot(ny_precinct_f, aes(long, lat, group = group, fill=`2020`>3000)) +
  geom_polygon() + geom_path(colour="white", lwd=0.05) + coord_equal() +
  labs(x = "lat", y = "lon",
       fill = "#Crime > 3000") +
  scale_fill_manual(values=c("#BDBDBD","#D55E00")) +
  ggtitle("#Crime > 3000 (2020) ") 
```
#plots the precinct with crime cases below 1000 Mark as Green
```{r}
ggplot(ny_precinct_f, aes(long, lat, group = group, fill=`2020`<1000)) +
  geom_polygon() + geom_path(colour="white", lwd=0.05) + coord_equal() +
  labs(x = "lat", y = "lon",
       fill = "#Crime < 1000") +
  scale_fill_manual(values=c("#BDBDBD","#009E73")) +
  ggtitle("#Crime < 1000 (2020) ") 
```


#Now let's further discuss the bias in predictive policing field using COMPAS dataset.
# From the distribution crossing race, we found African-American and Caucasian are two races with the largest number of criminals. To ensure that the sample size is large enough for research, we select these top two races for future research.
```{r}
#Plot 1
Race_Count<-df%>%
  group_by(race) %>%
  dplyr::summarise(count = n())%>%
  arrange(desc(count)) %>% 
  ggplot(aes(fct_reorder(race,count,.desc = FALSE),count))+
  geom_col(color="grey50",fill="lightpink")+
  coord_flip()+
  xlab("Which RACE")+
  ylab("Count of each RACE")+
  geom_text(aes(label=count), hjust=0.5)+
  ggtitle("Number of Defendants in Each Race")
Race_Count
```
#The COMPAS model gives each defendant a decile score to rank the possibility of them committing a crime again and classifies people into High(8-10), Medium(5-7) and Low risk(1-4) corresponding to decile score. We first explore how the decile scores are distributed in African-American and Caucaian. 

```{r}
#Plot 2
ggplot(data=filter(df,race=='African-American'|race=='Caucasian'), aes(x=decile_score, group=race, fill=race)) +
  geom_density(adjust=1.5, alpha=.4) +
  ggtitle("Black and White Defendant's Decile Scores")
```
#From the density plot, we can tell there is a clear downward trend in the decile scores as those scores increase for white defendants. However, the score for black people is more like a uniform distribution. We can't help questioning whether there is a significant difference in recidivism scores between races. We decided to use logistic regression to get a quantitative look on it.


```{r}
summary(df$age_cat)
```


```{r}
summary(df$race)
```

```{r}
summary(df$sex)
```

Part2 Whether there is a Significant Difference in COMPAS Scores Between Races

```{r}
df <-  
      mutate(df, age_factor = as.factor(age_cat)) %>%
      within(age_factor <- relevel(age_factor, ref = 1)) %>%
      mutate(race_factor = factor(race)) %>%
      within(race_factor <- relevel(race_factor, ref = 3)) %>%
      mutate(gender_factor = factor(sex, labels= c("Female","Male"))) %>%
      within(gender_factor <- relevel(gender_factor, ref = 2)) %>%
      mutate(score_factor = factor(score_text != "Low", labels = c("LowScore","HighScore")))

model <- glm(score_factor ~ gender_factor + age_factor + race_factor, family="binomial", data=df)
summary(model)
```
From the logistic regression output we found that most p-values of different race variables are less than 0.05, thus there is a significant difference in Compas score between races, which is the same as our previous guess. 


```{r}
#explore the socre's difference between white and black people
control <- exp(-0.55712) / (1 + exp( -0.55712))
exp(0.85966) / (1 - control + (control * exp(0.85966)))
```
By futher exploration, we learned Black defendants are 58% more likely than white defendants to receive a higher score for people in the same age and sex. This outcome supports our suspicion about race bias on CAMPOS score. 

```{r}
#Plot 3
#Mosaic Plot for Black and white people with low or high socre
beauty_color<-c("#D55E00","#E69F00")
black_white <- df %>%
  filter(race=='African-American'|race=='Caucasian')%>%
  filter(score_text=='Low'|score_text=='High')
vcd::mosaic(race~score_text,black_white,highlighting_fill=beauty_color)
```
From the mosaic plot above, we also can see that black people are more likely to have a higher score.

However, the other said that black defendants have a higher risk score because that they scored higher input factors, such as drug problems, correlated to race.

In order to verify their claims, we further studied the relationship between drug crimes and races.  

Part 3 If the Drug Crimes Occurred More Often Among Blacks
```{r}
dt<-readxl::read_excel("/Users/jessie/Desktop/STAT 5702/Final Project/12 Variables NYPD Arrest Data.xlsx")

dt$AGE_GROUP = as.factor(dt$AGE_GROUP)
summary(dt$AGE_GROUP)
```

```{r}
dt$PERP_RACE = as.factor(dt$PERP_RACE)
summary(dt$PERP_RACE)
```

```{r}
dt$PERP_SEX = as.factor(dt$PERP_SEX)
summary(dt$PERP_SEX)
```


```{r}
ifdrug <- dt %>%
      mutate(Drug = ifelse(OFNS_DESC == "DANGEROUS DRUGS",1,0))
```


```{r}
#Plot 4
#Mosaic Plot for Black and white people with low or high socre
beauty_color<-c("#0072B2","#CC79A7")
black_white_ifdrug<-ifdrug%>%
  filter(PERP_RACE=='BLACK'|PERP_RACE=='WHITE')%>%
  droplevels

vcd::mosaic(PERP_RACE~Drug,black_white_ifdrug,highlighting_fill=beauty_color)
```
#We first did a data visualization exploratory to have a initial glance on the drug crime of black and white people.From the Mosaic plot above we see that white people actually had a slightly larger proportion involving with drug crime, which was conflicted with the statement about black defendants have a higher risk score is because that they scored higher input factors, such as drug problem. 

#Then, we did a logistic regression corresponding to whether the arrest of the criminal was caused by the dangerous drug trade.
```{r}
#Set white male with age less than 18 as the base level
ifdrug <-  
      mutate(ifdrug, AGE_GROUP = as.factor(AGE_GROUP)) %>%
      within(AGE_GROUP <- relevel(AGE_GROUP, ref = 1)) %>%
      mutate(PERP_RACE = factor(PERP_RACE)) %>%
      within(PERP_RACE <- relevel(PERP_RACE, ref = 6)) %>%
      mutate(PERP_SEX = factor(PERP_SEX, labels= c("Female","Male"))) %>%
      within(PERP_SEX <- relevel(PERP_SEX, ref = 2)) #%>%
      #mutate(score_factor = factor(score_text != "Low", labels = c("LowScore","HighScore")))

#Do logistic regression on if people were arrested due to the drug problem
model <- glm(Drug ~ PERP_RACE + AGE_GROUP + PERP_SEX, family="binomial", data=ifdrug)
summary(model)
```

```{r}
control <- exp(-3.79738) / (1 + exp( -3.79738))
1 - exp(-0.07857) / (1 - control + (control * exp(-0.07857)))
```
# From the logistic result we know that black people actually 7.4% less likely than white people to get invlve in the drug problems for people with same age and sex.

#Thus, the statement that black defendants have a higher risk score because they scored higher on drug problems was invalid. 

Part 4 Direction of the Racial Bias 

#In order to further explore the score bias among races. We decided to use a confusion matrix to see the percentage of defendants who did not recidivate, but got high scores and the percentage of defendants who recidivate, but got low scores in black and white people.
```{r}
black_rev_score <- dplyr::select(raw_data, race,score_text,is_recid) %>% 
        filter(score_text !=  "Medium") %>%
        filter(race == "African-American") %>%
        mutate(Predicted = ifelse(score_text == "High",1,0))%>%
        dplyr::rename(Recidivated = is_recid)%>%
        mutate(Recidivated = as.factor(Recidivated)) %>%
        mutate(Predicted = as.factor(Predicted)) %>%
        mutate(score_text = as.factor(score_text))
```


```{r}
#Black defendants
#confusion matrix of Recidivated and Predicted
confusion_matrix<- confusionMatrix(data = black_rev_score$Predicted, reference = black_rev_score$Recidivated)
confusion_matrix
```

```{r}
#All defendants
#False Positive Rate(Type I Error) = 1 - Sensitivity
1-0.7857
#False Negtive Rate(Type 2 error) = 1 - Specificity
1-0.5661
```
#Calculated from the confusion matrix of black defendants, we know that there is 21.34% chance that a black defendant will not recidivate, but labeled high and 43.39% chance that a black defendant will recidivate, but labeled low for black defendants.

```{r}
white_rev_score <- dplyr::select(raw_data, race,score_text,is_recid) %>% 
        filter(score_text !=  "Medium") %>%
        filter(race == "Caucasian") %>%
        mutate(Predicted = ifelse(score_text == "High",1,0))%>%
        dplyr::rename(Recidivated = is_recid)%>%
        mutate(Recidivated = as.factor(Recidivated)) %>%
        mutate(Predicted = as.factor(Predicted)) %>%
        mutate(score_text = as.factor(score_text))
```

```{r}
#White defendants
#confusion matrix of Recidivated and Predicted
confusion_matrix<- confusionMatrix(data = white_rev_score$Predicted, reference = white_rev_score$Recidivated)
confusion_matrix
```

```{r}
#All defendants
#False Positive Rate(Type I Error) = 1 - Sensitivity
1- 0.9361 
#False Negtive Rate(Type 2 error) = 1 - Specificity
1-0.2859
```
#Using the same logic we know that 6.39% chance that a white defendant will not recidivate, but labeled high and 71.41% chance that a defendant will recidivate, but labeled low for white defendants.

```{r}
#Table for comparison
tab <- matrix(c(21.34, 43.39, 6.39, 71.41), ncol=2, byrow=FALSE)
colnames(tab) <- c('Black','White')
rownames(tab) <- c('Did not recidivate, but labeled high(%)','Recidivated, but labeled low(%)')
tab <- as.table(tab)
tab 
```

```{r}
#Create a data frame for visualization
df_percentage <- data.frame (Race  = c("Black", "Black", "White","White"),
                  Situation = c("Did not recidivate, but labeled high(%)", "Recidivated, but labeled low(%)","Did not recidivate, but labeled high(%)", "Recidivated, but labeled low(%)"),
                  Percentage = c(21.34,43.39,6.39,71.41))
```

```{r}
#Plot 5
#race + if re-offend + percentage (facet histogram)
ggplot(data=df_percentage) +
   geom_bar(aes(x=Race,fill=Percentage))+
   labs(title = "The race distribution among different sex groups",fill="offense")+
   facet_wrap(~Situation)
   
```

In the facet histogram above, brighter colors in the graph represent a higher percentage. Therefore, we see that black defendants are more likely to be labeled high, although would not recidivate. However, white defendants are more likely to be labeled low, although they would recidivate. 
